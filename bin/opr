#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=C0116,C0413,W0212


"write your own commands"


import importlib
import importlib.util
import os
import sys


sys.path.insert(0, os.getcwd())


from opr import Cfg, Client, Command, Wd
from opr import command, launch, parse, scan, scandir, wait


Wd.workdir = os.path.expanduser("~/.opr")


class CLI(Client):


    def announce(self, txt):
        pass

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()


def boot(txt):
    parse(txt)
    if "c" in Cfg.opts:
        Cfg.console = True
    if "d" in Cfg.opts:
        Cfg.daemon = True
    if "i" in Cfg.opts:
        Cfg.init = True
    if "v" in Cfg.opts:
        Cfg.verbose = True
    if "w" in Cfg.opts:
        Cfg.wait = True


def importer(pname, mname, path=None, init=False):
    if not path:
        path = pname
    mod = None
    spec = importlib.util.spec_from_file_location(mname, path)
    if spec:
        mod = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(mod)
        scan(mod)
    if init and "init" in dir(mod):
        launch(mod.init)
    return mod



if __name__ == "__main__":
    boot(" ".join(sys.argv[1:]))
    scandir("mod", importer, Cfg.sets.mods or "cmds,log,tdo")
    cli = CLI()
    command(cli, Cfg.otxt)
    sys.stdout.flush()