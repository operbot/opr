#!/usr/bin/env python3
# This file is placed in the Public Domain.


import importlib
import os
import shutil
import sys
import termios
import time
import traceback


sys.path.insert(0, os.getcwd())


from opr import Object, Wd,  elapsed, keys, name, printable
from opr import Cfg, Command, Event, Handler, launch, parse, scandir, scan


Cfg.debug = True
Cfg.threaded = False
Cfg.verbose = False
Cfg.version = "103"
Wd.workdir = ".test"


events = []
results = []


param = Object()
param.cfg = ["server=localhost"]
param.cmd = [""]
param.cor = ["bthate@gmail.com"]
param.dlt = ["test@shell"]
param.dne = ["test4"]
param.dpl = ["reddit title,summary,link"]
param.eml = ["bthate@gmail.com"]
param.flt = ["", "0"]
param.ftc = [""]
param.log = ["test1"]
param.mbx = ["~/25-01-2013"]
param.met = ["test@shell"]
param.mre = [""]
param.nme = ["reddit reddit"]
param.pwd = ["bart test"]
param.rem = ["reddit"]
param.rss = ["https://www.reddit.com/r/python/.rss"]
param.sts = [""]
param.tdo = ["test4", ""]
param.thr = [""]
param.upt = [""]



def cprint(txt):
    print(txt)
    sys.stdout.flush()


class CLI(Handler):

    def __init__(self):
        Handler.__init__(self)

    def raw(self, txt):
        if Cfg.verbose:
            cprint(txt)


def consume(evts):
    fixed = []
    res = []
    for evt in evts:
        evt.wait()
        fixed.append(evt)
    for fix in fixed:
        try:
            evts.remove(fix)
        except ValueError:
            continue
    return res


def from_exception(exc):
    result = []
    for frm in traceback.extract_tb(exc.__traceback__)[::-1]:
        result.append("%s:%s" % (os.sep.join(frm.filename.split(os.sep)[-2:]), frm.lineno))
    return "%s(%s) %s" % (name(exc), exc, " ".join(result))


def importer(packagename, modulename):
    name = "%s.%s" % (packagename, modulename)
    try:
        mod = importlib.import_module(name, packagename)
        scan(mod)
    except Exception as ex:
        print(from_exception(ex))


def payload(cli):
    cmds = sorted(Command.cmd)
    _nr = 0
    for cmd in cmds:
        for ex in getattr(param, cmd, [""]):
            evt = Event()
            evt.txt = cmd + " " + ex
            evt.orig = repr(cli)
            evt.parse()
            #print(evt)
            #cli.put(evt)
            cli.handle(evt)
            events.append(evt)
            _nr += 1
    return _nr


def wrap(func):
    fds = sys.stdin.fileno()
    old = termios.tcgetattr(fds)
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        cprint("")
    finally:
        termios.tcsetattr(fds, termios.TCSADRAIN, old)


def main():
    cprint("OPERBOT tinder start at %s" % time.ctime(time.time()).replace("  ", " "))
    if os.path.exists(Wd.workdir):
        shutil.rmtree(Wd.workdir)
    txt = " ".join(sys.argv[1:])
    cfg = parse(txt)
    if "v" in cfg.opts:
        Cfg.verbose = True
    cprint(printable(Cfg, keys(Cfg)))
    scandir("mod", importer)
    print("commands: " +  ",".join(sorted(Command.cmd)))
    cli = CLI()
    #cli.start()
    nrs = cfg.index or 20
    res = 1
    thrs = []
    starttime = time.time()
    for _nr in range(nrs):
        #thrs.append(launch(payload(cli)))
        payload(cli)
    if thrs:
        for thr in thrs:
            res += thr.join()
    else:
        res = nrs * len(Command.cmd)
    if not res:
        res = 1
    consume(events)
    endtime = time.time()
    print("%s %s %s (%s remaining)" %  (
                                        elapsed(endtime - starttime),
                                        res,
                                        (endtime - starttime)/res, len(events))
                                       )


wrap(main)
